parameters:
- name: IncludeHigherPriorityTestSuites
  default: $(IncludeHigherPriorityTestSuites)
- name: TestSuite
  default: $(TestSuite)

steps:
- powershell: |
   # These should have been set by the variables in a pipeline
   
   Write-Host "TestSuite = $(TestSuite)"
   Write-Host "IncludeHigherPriorityTestSuites = $(IncludeHigherPriorityTestSuites)"
   
  displayName: 'Display Parameter Values'

- task: securedevelopmentteam.vss-secure-development-tools.build-task-antimalware.AntiMalware@4
  displayName: '(P0) Run AntiMalware/MpCmdRun.exe: Defaults'
  continueOnError: true
  condition: and(succeeded(), or(eq(variables['TestSuite'], 'P0'), eq(variables['IncludeHigherPriorityTestSuites'], 'true')))

- task: securedevelopmentteam.vss-secure-development-tools.build-task-antimalware.AntiMalware@4
  displayName: '(P1) Run AntiMalware/MpCmdRun.exe: Custom command line'
  inputs:
    InputType: Custom
  continueOnError: true
  condition: and(succeeded(), or(eq(variables['TestSuite'], 'P1'), and(eq(variables['TestSuite'], 'P2'), eq(variables['IncludeHigherPriorityTestSuites'], 'true'))))
  
- task: securedevelopmentteam.vss-secure-development-tools.build-task-antimalware.AntiMalware@4
  displayName: '(P1) Run AntiMalware/MpCmdRun.exe: Force Signature Update'
  inputs:
    ForceSignatureUpdate: true
  continueOnError: true
  condition: and(succeeded(), or(eq(variables['TestSuite'], 'P1'), and(eq(variables['TestSuite'], 'P2'), eq(variables['IncludeHigherPriorityTestSuites'], 'true'))))

- task: securedevelopmentteam.vss-secure-development-tools.build-task-antimalware.AntiMalware@4
  displayName: '(P1) Run AntiMalware/MpCmdRun.exe: Validate Signature Update As Error'
  inputs:
    TreatSignatureUpdateFailureAs: Error
  continueOnError: true
  condition: and(succeeded(), or(eq(variables['TestSuite'], 'P1'), and(eq(variables['TestSuite'], 'P2'), eq(variables['IncludeHigherPriorityTestSuites'], 'true'))))
  
- task: securedevelopmentteam.vss-secure-development-tools.build-task-antimalware.AntiMalware@4
  displayName: '(P1) Run AntiMalware/MpCmdRun.exe: AntiMalware Signature Age (24 hours)'
  inputs:
    SignatureFreshness: OneDay
  continueOnError: true
  condition: and(succeeded(), or(eq(variables['TestSuite'], 'P1'), and(eq(variables['TestSuite'], 'P2'), eq(variables['IncludeHigherPriorityTestSuites'], 'true'))))

- task: securedevelopmentteam.vss-secure-development-tools.build-task-antimalware.AntiMalware@4
  displayName: '(P1) Run AntiMalware/MpCmdRun.exe: Validate Signatures Age As Warning'
  inputs:
    TreatStaleSignatureAs: Warning
  continueOnError: true
  condition: and(succeeded(), or(eq(variables['TestSuite'], 'P1'), and(eq(variables['TestSuite'], 'P2'), eq(variables['IncludeHigherPriorityTestSuites'], 'true'))))

- task: securedevelopmentteam.vss-secure-development-tools.build-task-antimalware.AntiMalware@4
  displayName: '(P2) Run AntiMalware/MpCmdRun.exe: Validate Signature Update As Informational'
  inputs:
    TreatSignatureUpdateFailureAs: Standard
  continueOnError: true
  condition: and(succeeded(), eq(variables['TestSuite'], 'P2'))

- task: securedevelopmentteam.vss-secure-development-tools.build-task-antimalware.AntiMalware@4
  displayName: '(P2) Run AntiMalware/MpCmdRun.exe: AntiMalware Signature Age (48 hours)'
  inputs:
    SignatureFreshness: TwoDays
  continueOnError: true
  condition: and(succeeded(), eq(variables['TestSuite'], 'P2'))

- task: securedevelopmentteam.vss-secure-development-tools.build-task-antimalware.AntiMalware@4
  displayName: '(P2) Run AntiMalware/MpCmdRun.exe: AntiMalware Signature Age (72 hours)'
  inputs:
    SignatureFreshness: ThreeDays
  continueOnError: true
  condition: and(succeeded(), eq(variables['TestSuite'], 'P2'))

- task: securedevelopmentteam.vss-secure-development-tools.build-task-antimalware.AntiMalware@4
  displayName: '(P2) Run AntiMalware/MpCmdRun.exe: Validate Signatures Age As Informational'
  inputs:
    TreatStaleSignatureAs: Standard
  continueOnError: true
  condition: and(succeeded(), eq(variables['TestSuite'], 'P2'))

- task: securedevelopmentteam.vss-secure-development-tools.build-task-antimalware.AntiMalware@4
  displayName: '(P2) Run AntiMalware/MpCmdRun.exe: Combinations'
  inputs:
    ForceSignatureUpdate: true
    SignatureFreshness: OneDay
    TreatStaleSignatureAs: Warning
  continueOnError: true
  condition: and(succeeded(), eq(variables['TestSuite'], 'P2'))

- task: securedevelopmentteam.vss-secure-development-tools.build-task-antimalware.AntiMalware@4
  displayName: '(P2) Run AntiMalware/MpCmdRun.exe: Quick scan'
  inputs:
    ScanType: QuickScan
  continueOnError: true
  condition: and(succeeded(), eq(variables['TestSuite'], 'P2'))

- task: securedevelopmentteam.vss-secure-development-tools.build-task-antimalware.AntiMalware@4
  displayName: '(P2) Run AntiMalware/MpCmdRun.exe: Boot Sector Scan included'
  inputs:
    BootSectorScan: true
  continueOnError: true
  condition: and(succeeded(), eq(variables['TestSuite'], 'P2'))

- task: securedevelopmentteam.vss-secure-development-tools.build-task-antimalware.AntiMalware@4
  displayName: '(P2) Run AntiMalware/MpCmdRun.exe: Enable Remediation'
  continueOnError: true
  condition: and(succeeded(), eq(variables['TestSuite'], 'P2'))
  